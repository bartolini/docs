---
description: Monitor live traffic for malicious activities.
---

# Deep packet inspection

## Big picture

Configure Deep Packet Inspection (DPI) in clusters to get alerts on compromised resources.

## Value

Security teams need to run DPI quickly in response to unusual network traffic in clusters so they can identify potential threats. Also, it is critical to run DPI on select workloads (not all) to efficiently make use of cluster resources and minimize the impact of false positives. {{prodname}} provides an easy way to perform DPI using [Snort community rules](https://www.snort.org/downloads/#rule-downloads). You can disable DPI at any time, selectively configure for namespaces and endpoints, and alerts are generated in the Security Events dashboard in Manager UI.

## Concepts

For each deep packet inspection resource (DeepPacketInspection), {{prodname}} creates a live network monitor that inspects the header and payload information of packets that match the Snort community rules. Whenever malicious activities are suspected, an alert is automatically added to the Security Events page in the {{prodname}} Manager.

{{prodname}} DPI uses AF_PACKET, a Linux socket that allows an application to receive and send raw packets. It is commonly used for troubleshooting (like tcpdump and Wireshark), but also for network intrusion detection. For details, see [AF_Packet](https://man7.org/linux/man-pages/man7/packet.7.html).

## Before you begin

**Not supported:**

- Multi-nic setup
- {{prodname}} nodes running Windows hosts

## How To

- [Configure deep packet inspection](#configure-deep-packet-inspection)
- [Configure resource requirements](#configure-resource-requirements)
- [Access alerts](#access-alerts)
- [Verify deep packet inspection is running](#verify-deep-packet-inspection-is-running)

### Configure deep packet inspection

Create a YAML file containing one or more [DeepPacketInspection](../reference/resources/deeppacketinspection.mdx) resources and apply it to your cluster.

```bash
kubectl apply -f <your_deep_packet_inspection_filename>
```

To stop deep packet inspection, delete the DeepPacketInspection resource from your cluster.

```bash
kubectl delete -f <your_deep_packet_inspection_filename>
```

**Examples of selecting workloads**

Following is a basic example that selects a single workload that has the label `k8s-app` with the value `nginx`.

```yaml
apiVersion: projectcalico.org/v3
kind: DeepPacketInspection
metadata:
  name: sample-dpi-nginx
  namespace: sample
spec:
  selector: k8s-app == "nginx"
```

In the following example, we select all workload endpoints in the `sample` namespace.

```yaml
apiVersion: projectcalico.org/v3
kind: DeepPacketInspection
metadata:
  name: sample-dpi-all
  namespace: sample
spec:
  selector: all()
```

### Configure resource requirements

Adjust the CPU and RAM used for performing deep packet inspection by updating the [component resource in IntrusionDetection](../reference/installation/api.mdx#operator.tigera.io/v1.IntrusionDetectionComponentResource).

For a data transfer rate of 1GB/sec on workload endpoints being monitored, we recommend a minimum of 1 CPU and 1GB RAM.

The following example configures deep packet inspection to use a maximum of 1 CPU and 1GB RAM.

```yaml
apiVersion: operator.tigera.io/v1
kind: IntrusionDetection
metadata:
  name: tigera-secure
spec:
  componentResources:
    - componentName: DeepPacketInspection
      resourceRequirements:
        limits:
          cpu: '1'
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 100Mi
```

### Access alerts

The alerts generated by deep packet inspection are available in the Manager UI in the **Security Events** page.

### Verify deep packet inspection is running

Get the [status of DeepPacketInspection](../reference/resources/deeppacketinspection.mdx#status) resource to verify if live traffic is being monitored on selected workload endpoints.

```bash
kubectl get <deep_packet_inspection_resource_name> -n <deep_packet_inspection_namespace>
```

### Install custom Snort rules

Installation of custom Snort rules for Calico deep packet inspection is a process that involves:
1. Building a Docker image for the DPI init container with custom Snort rules.
3. Configuration of the IntrusionDetection resource.

#### Init container with custom Snort rules

Assuming working in an empty directory:

- copy your Snort rule files into `./snort-rules` directory
- create a `Dockerfile` like this one:

```yaml
FROM alpine:3.14
COPY snort-rules /snort-rules
ENTRYPOINT [ "/bin/sh", "-c", "cp /snort-rules/* /usr/etc/snort/rules/" ]
```

- in the console issue the following commands:

```bash
docker build . -t your-image-name:image-tag
docker push your-image-name:image-tag
```

After the image has been pushed to the registry you're ready to configure the `IntrusionDetection` resource.

#### Configuration of the IntrusionDetection resource

Patch the `IntrusionDetection` resource to contain the following data:

```yaml
spec:
  deepPacketInspectionDaemonset:
    spec:
      template:
        spec:
          initContainers:
          - name: snort-rules
            image: your-image:tag
```

This can be done using the `kubectl` command as follows:

```bash
kubectl patch intrusiondetection tigera-secure --type merge -p '{"spec":{"deepPacketInspectionDaemonset":{"spec":{"template":{"spec":{"initContainers":[{"name":"snort-rules", "image":"your-image:tag"}]}}}}}}'
```

### Verify custom Snort rules installation

First, verify that deep packet inspection is running. Then, assuming working in an empty directory please issue the following commands:

```bash
export POD=$(kubectl get pods -n tigera-dpi -o custom-columns=:metadata.name --no-headers | head -n 1)
kubectl exec -n tigera-dpi $POD -- tar -cf - /usr/etc/snort/rules | tar --strip-components=4 -xf -
```

The directory will now contain Snort rules that are being used by the DPI.

## Additional resources

- [Configure packet capture](../visibility/packetcapture.mdx)
